<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>حاسبة تحويل العملة (قديم ↔ جديد)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    body { margin: 0; background: #f6f7fb; color: #111; -webkit-text-size-adjust: 100%; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 14px; }
    .card { background: #fff; border-radius: 18px; padding: 14px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    .top { display: flex; gap: 10px; align-items: baseline; flex-wrap: wrap; }
    h1 { margin: 0; font-size: 20px; }
    .sub { margin: 10px 0 0; opacity: .85; font-size: 13px; line-height: 1.7; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #f1f2f7; font-size: 12px; opacity: .95; }

    .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin: 14px 0 0; }
    .tab {
      border: 0; border-radius: 999px; padding: 12px 14px; font-size: 15px; cursor: pointer;
      background: #eef0ff; color: #111; min-height: 44px;
    }
    .tab.active { background: #111; color: #fff; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 12px; }

    .box { border: 1px solid #e3e6f2; border-radius: 16px; padding: 12px; background: #fff; }
    .boxTitle { font-size: 13px; opacity: .85; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .mini { font-size: 12px; opacity: .7; line-height: 1.6; }

    label { display: block; font-size: 13px; margin-bottom: 6px; opacity: .9; }
    input {
      width: 100%; padding: 12px 12px; font-size: 22px;
      border: 1px solid #d9dbe7; border-radius: 12px; outline: none; background: #fff;
      min-height: 52px;
    }
    input:focus { border-color: #6b6eea; box-shadow: 0 0 0 3px rgba(107,110,234,.15); }

    .row { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; align-items: center; }
    button {
      border: 0; border-radius: 14px; padding: 12px 14px; font-size: 15px;
      cursor: pointer; background: #111; color: #fff; min-height: 44px;
    }
    button.secondary { background: #eef0ff; color: #111; }
    button.ghost { background: #f1f2f7; color: #111; }
    button.full { width: 100%; }

    .btn2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .btn2 button { border-radius: 16px; font-size: 15px; }

    .outCard { margin-top: 14px; border-radius: 18px; padding: 14px; background: #0f172a; color: #fff; }
    .outLine { font-size: 16px; margin: 8px 0; display: flex; justify-content: space-between; gap: 12px; }
    .outLabel { opacity: .85; }
    .outValue { font-size: 22px; font-weight: 800; }
    .muted { opacity: .78; font-size: 12px; line-height: 1.7; margin-top: 10px; }
    .warn { font-size: 12px; color: #ffd2d2; opacity: .95; margin-top: 8px; }
    .ok { color: #b9ffcf; }
    .bad { color: #ffb4b4; }

    .toggleGroup { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .toggleGroup button { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.18); }
    .toggleGroup button.active { background: #fff; color: #0f172a; border-color: #fff; font-weight: 700; }

    details { margin-top: 12px; }
    summary { cursor: pointer; font-size: 13px; opacity: .85; }

    .hidden { display: none !important; }

    /* Mobile first: default to single column */
    @media (max-width: 820px) {
      .grid, .grid3 { grid-template-columns: 1fr; }
      .btn2 { grid-template-columns: 1fr; }
      .toggleGroup { grid-template-columns: 1fr; }
      .wrap { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <h1>حاسبة تحويل العملة (قديم ↔ جديد)</h1>
        <span class="pill" id="rulePill">قاعدة التحويل: ١ جديدة = ١٠٠ قديمة</span>
      </div>

      <p class="sub">
        لتحويل المبالغ بين العملتين أو للتحقق من <b>الباقي</b> أثناء الدفع.
        <br><span class="mini">تدعم الأرقام العربية (١٢٣) والفواصل مثل 50,000 أو 50 000.</span>
      </p>

      <div class="tabs" role="tablist" aria-label="اختيار الوضع">
        <button class="tab active" id="tabConvert" type="button">تحويل / جمع</button>
        <button class="tab" id="tabChange" type="button">الباقي / التحقق</button>
      </div>

      <!-- ===================== وضع التحويل ===================== -->
      <section id="sectionConvert">
        <div class="grid">
          <div class="box">
            <div class="boxTitle">
              <span>السعر أو المبلغ</span>
              <span class="mini">اضغط على زر “السعر مكتوب…” لتسهيل الإدخال</span>
            </div>

            <div class="btn2">
              <button id="priceIsNewBtn" type="button">السعر مكتوب بالعملة الجديدة</button>
              <button class="secondary" id="priceIsOldBtn" type="button">السعر مكتوب بالعملة القديمة</button>
            </div>

            <div class="grid" style="margin-top:12px;">
              <div>
                <label for="oldAmt">المبلغ بالعملة القديمة</label>
                <input id="oldAmt" inputmode="numeric" placeholder="مثال: 500000" />
              </div>
              <div>
                <label for="newAmt">المبلغ بالعملة الجديدة</label>
                <input id="newAmt" inputmode="numeric" placeholder="مثال: 500" />
              </div>
            </div>

            <div class="mini" style="margin-top:10px;">
              إذا كان السعر مكتوباً بالجديدة فقط: اجعل القديمة = 0 وأدخل السعر بالجديدة. والعكس صحيح.
            </div>
          </div>

          <div class="box">
            <div class="boxTitle">
              <span>النتيجة</span>
              <span class="mini">يمكن نسخها بسرعة</span>
            </div>

            <div class="outCard" aria-live="polite">
              <div class="outLine">
                <span class="outLabel">الإجمالي بالعملة الجديدة</span>
                <span class="outValue" id="totalNew">0</span>
              </div>
              <div class="outLine">
                <span class="outLabel">الإجمالي بالعملة القديمة</span>
                <span class="outValue" id="totalOld">0</span>
              </div>
              <div class="warn" id="convertWarn"></div>
            </div>

            <div class="row">
              <button class="full" id="copyConvert" type="button">نسخ النتيجة</button>
              <span class="mini" id="copyConvertStatus"></span>
            </div>

            <details>
              <summary>إضافة الاختصار للهاتف (كأنه تطبيق)</summary>
              <div class="mini" style="margin-top:8px;">
                <b>iPhone:</b> مشاركة → “إضافة إلى الشاشة الرئيسية”.<br>
                <b>Android:</b> القائمة ⋮ → “Add to Home screen / إضافة إلى الشاشة الرئيسية”.
              </div>
            </details>
          </div>
        </div>
      </section>

      <!-- ===================== وضع الباقي/التحقق ===================== -->
      <section id="sectionChange" class="hidden">
        <div class="box" style="margin-top:12px;">
          <div class="boxTitle">
            <span>التحقق من الباقي</span>
            <span class="mini">سعر + مدفوع + باقي مستلم → يظهر الفرق</span>
          </div>

          <div class="btn2">
            <button id="changePriceIsNewBtn" type="button">السعر مكتوب بالعملة الجديدة</button>
            <button class="secondary" id="changePriceIsOldBtn" type="button">السعر مكتوب بالعملة القديمة</button>
          </div>

          <div class="grid3">
            <div class="box">
              <div class="boxTitle"><span>السعر</span><span class="mini">أدخل قيمة واحدة</span></div>
              <label for="priceOld">بالقديمة</label>
              <input id="priceOld" inputmode="numeric" placeholder="مثال: 50000" />
              <div style="height:10px"></div>
              <label for="priceNew">بالجديدة</label>
              <input id="priceNew" inputmode="numeric" placeholder="مثال: 500" />
            </div>

            <div class="box">
              <div class="boxTitle"><span>المدفوع</span><span class="mini">يمكن إدخال عملتين</span></div>
              <label for="paidOld">بالقديمة</label>
              <input id="paidOld" inputmode="numeric" placeholder="مثال: 100000" />
              <div style="height:10px"></div>
              <label for="paidNew">بالجديدة</label>
              <input id="paidNew" inputmode="numeric" placeholder="مثال: 0" />
            </div>

            <div class="box">
              <div class="boxTitle"><span>الباقي المستلم</span><span class="mini">يمكن إدخال عملتين</span></div>
              <label for="changeOld">بالقديمة</label>
              <input id="changeOld" inputmode="numeric" placeholder="مثال: 50000" />
              <div style="height:10px"></div>
              <label for="changeNew">بالجديدة</label>
              <input id="changeNew" inputmode="numeric" placeholder="مثال: 0" />
            </div>
          </div>

          <div class="row">
            <button class="secondary full" id="clearChange" type="button">مسح</button>
          </div>

          <div class="outCard" aria-live="polite" id="changeOutCard">
            <div class="outLine">
              <span class="outLabel" id="lblPrice">السعر</span>
              <span class="outValue" id="priceTotal">0</span>
            </div>
            <div class="outLine">
              <span class="outLabel" id="lblPaid">المدفوع</span>
              <span class="outValue" id="paidTotal">0</span>
            </div>
            <div class="outLine">
              <span class="outLabel" id="lblExpected">الباقي المتوقع</span>
              <span class="outValue" id="expectedChange">0</span>
            </div>
            <div class="outLine">
              <span class="outLabel" id="lblReceived">الباقي المستلم</span>
              <span class="outValue" id="receivedChange">0</span>
            </div>
            <div class="outLine">
              <span class="outLabel" id="lblDiff">الفرق</span>
              <span class="outValue" id="diff">0</span>
            </div>

            <!-- message -->
            <div class="muted" id="changeVerdict">—</div>
            <div class="warn" id="changeWarn"></div>

            <!-- toggle under black section -->
            <div class="toggleGroup" aria-label="تبديل عرض العملة">
              <button id="showOldBtn" class="active" type="button">عرض بالعملة القديمة</button>
              <button id="showNewBtn" type="button">عرض بالعملة الجديدة</button>
            </div>
          </div>

          <div class="row">
            <button class="full" id="copyChange" type="button">نسخ ملخص التحقق</button>
            <span class="mini" id="copyChangeStatus"></span>
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
    // ====================== الإعداد ======================
    const OLD_PER_NEW = 100;

    // ---------------------- أدوات مساعدة ----------------------
    function normalizeArabicDigits(str) {
      const map = { '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9',
                    '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9' };
      return String(str).replace(/[٠-٩۰-۹]/g, d => map[d] ?? d);
    }

    function parseNumber(s) {
      if (!s) return 0;
      const normalized = normalizeArabicDigits(s);
      const cleaned = normalized.replace(/[,\s\u066C\u066B]/g, '');
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : NaN;
    }

    function fmtAr(n) {
      try { return new Intl.NumberFormat('ar').format(n); }
      catch { return String(n); }
    }

    function fmtArNew(n) {
      // new currency: show up to 2 decimals only if needed
      const rounded = Math.round(n * 100) / 100;
      const isInt = Math.abs(rounded - Math.round(rounded)) < 1e-9;
      return fmtAr(isInt ? Math.round(rounded) : rounded);
    }

    async function copyText(text, statusEl) {
      try {
        await navigator.clipboard.writeText(text);
        statusEl.textContent = 'تم النسخ ✅';
        setTimeout(() => statusEl.textContent = '', 1500);
      } catch (e) {
        statusEl.textContent = 'لم يتم النسخ (جرّب النسخ يدوياً)';
        setTimeout(() => statusEl.textContent = '', 2500);
      }
    }

    function setActive(btnA, btnB, activeA) {
      btnA.classList.toggle('active', activeA);
      btnB.classList.toggle('active', !activeA);
    }

    document.getElementById('rulePill').textContent =
      `قاعدة التحويل: ١ جديدة = ${fmtAr(OLD_PER_NEW)} قديمة`;

    // ====================== التبويبات ======================
    const tabConvert = document.getElementById('tabConvert');
    const tabChange = document.getElementById('tabChange');
    const sectionConvert = document.getElementById('sectionConvert');
    const sectionChange = document.getElementById('sectionChange');

    function showTab(which) {
      const isConvert = which === 'convert';
      tabConvert.classList.toggle('active', isConvert);
      tabChange.classList.toggle('active', !isConvert);
      sectionConvert.classList.toggle('hidden', !isConvert);
      sectionChange.classList.toggle('hidden', isConvert);
    }
    tabConvert.addEventListener('click', () => showTab('convert'));
    tabChange.addEventListener('click', () => showTab('change'));

    // ====================== وضع التحويل ======================
    const oldAmt = document.getElementById('oldAmt');
    const newAmt = document.getElementById('newAmt');
    const totalOld = document.getElementById('totalOld');
    const totalNew = document.getElementById('totalNew');
    const convertWarn = document.getElementById('convertWarn');

    function updateConvert() {
      convertWarn.textContent = '';
      const o = parseNumber(oldAmt.value);
      const n = parseNumber(newAmt.value);

      if (Number.isNaN(o) || Number.isNaN(n)) {
        convertWarn.textContent = 'رجاءً إدخال أرقام صحيحة فقط.';
        return;
      }

      const sumOld = o + (n * OLD_PER_NEW);
      const sumNew = n + (o / OLD_PER_NEW);

      totalOld.textContent = fmtAr(Math.round(sumOld));
      totalNew.textContent = fmtArNew(sumNew);
    }

    oldAmt.addEventListener('input', updateConvert);
    newAmt.addEventListener('input', updateConvert);

    // “السعر مكتوب…”
    document.getElementById('priceIsNewBtn').addEventListener('click', () => {
      oldAmt.value = '0';
      newAmt.focus();
      updateConvert();
    });
    document.getElementById('priceIsOldBtn').addEventListener('click', () => {
      newAmt.value = '0';
      oldAmt.focus();
      updateConvert();
    });

    document.getElementById('copyConvert').addEventListener('click', () => {
      const text =
        `النتيجة:\n` +
        `- بالجديدة: ${totalNew.textContent}\n` +
        `- بالقديمة: ${totalOld.textContent}\n` +
        `قاعدة التحويل: 1 جديدة = ${OLD_PER_NEW} قديمة`;
      copyText(text, document.getElementById('copyConvertStatus'));
    });

    // ====================== وضع الباقي/التحقق ======================
    const priceOld = document.getElementById('priceOld');
    const priceNew = document.getElementById('priceNew');
    const paidOld = document.getElementById('paidOld');
    const paidNew = document.getElementById('paidNew');
    const changeOld = document.getElementById('changeOld');
    const changeNew = document.getElementById('changeNew');

    const priceTotal = document.getElementById('priceTotal');
    const paidTotal = document.getElementById('paidTotal');
    const expectedChange = document.getElementById('expectedChange');
    const receivedChange = document.getElementById('receivedChange');
    const diffEl = document.getElementById('diff');
    const changeVerdict = document.getElementById('changeVerdict');
    const changeWarn = document.getElementById('changeWarn');

    const showOldBtn = document.getElementById('showOldBtn');
    const showNewBtn = document.getElementById('showNewBtn');

    // display mode for black results in change tab
    let displayUnit = 'old'; // 'old' | 'new'

    function totalOldFromInputs(oldVal, newVal) {
      return oldVal + (newVal * OLD_PER_NEW);
    }

    function toNew(oldAmount) {
      return oldAmount / OLD_PER_NEW;
    }

    function unitLabel() {
      return displayUnit === 'old' ? 'بالعملة القديمة' : 'بالعملة الجديدة';
    }

    function formatByUnit(valueOld) {
      if (displayUnit === 'old') return fmtAr(Math.round(valueOld));
      return fmtArNew(toNew(valueOld));
    }

    function updateChange() {
      changeWarn.textContent = '';
      changeVerdict.textContent = '—';
      changeVerdict.className = 'muted';

      const pO = parseNumber(priceOld.value);
      const pN = parseNumber(priceNew.value);
      const payO = parseNumber(paidOld.value);
      const payN = parseNumber(paidNew.value);
      const chO = parseNumber(changeOld.value);
      const chN = parseNumber(changeNew.value);

      const arr = [pO,pN,payO,payN,chO,chN];
      if (arr.some(Number.isNaN)) {
        changeWarn.textContent = 'رجاءً إدخال أرقام صحيحة فقط.';
        return;
      }

      const priceOldTotal = totalOldFromInputs(pO, pN);
      const paidOldTotal = totalOldFromInputs(payO, payN);
      const receivedOldTotal = totalOldFromInputs(chO, chN);

      const expectedOld = paidOldTotal - priceOldTotal;
      const diffOld = receivedOldTotal - expectedOld; // + extra received, - shortage

      // Update labels with selected unit
      document.getElementById('lblPrice').textContent = `السعر (${unitLabel()})`;
      document.getElementById('lblPaid').textContent = `المدفوع (${unitLabel()})`;
      document.getElementById('lblExpected').textContent = `الباقي المتوقع (${unitLabel()})`;
      document.getElementById('lblReceived').textContent = `الباقي المستلم (${unitLabel()})`;
      document.getElementById('lblDiff').textContent = `الفرق (${unitLabel()})`;

      // Display values in chosen unit
      priceTotal.textContent = formatByUnit(priceOldTotal);
      paidTotal.textContent = formatByUnit(paidOldTotal);
      expectedChange.textContent = formatByUnit(expectedOld);
      receivedChange.textContent = formatByUnit(receivedOldTotal);
      diffEl.textContent = formatByUnit(diffOld);

      // Verdict message
      const absDiffOld = Math.abs(diffOld);

      if (Math.round(absDiffOld) === 0) {
        changeVerdict.textContent = 'النتيجة متطابقة ✅';
        changeVerdict.className = 'muted ok';
        return;
      }

      if (diffOld < 0) {
        // shortage: vendor owes additional amount
        const oweOld = absDiffOld;
        const oweNew = toNew(oweOld);
        changeVerdict.textContent =
          `على البائع أن يعيد لك ${fmtArNew(oweNew)} بالعملة الجديدة أو ${fmtAr(Math.round(oweOld))} بالعملة القديمة. ❗`;
        changeVerdict.className = 'muted bad';
      } else {
        // extra received
        const extraOld = absDiffOld;
        const extraNew = toNew(extraOld);
        changeVerdict.textContent =
          `تم استلام زيادة مقدارها ${fmtArNew(extraNew)} بالجديدة أو ${fmtAr(Math.round(extraOld))} بالقديمة. ✅`;
        changeVerdict.className = 'muted ok';
      }
    }

    [priceOld, priceNew, paidOld, paidNew, changeOld, changeNew].forEach(el => el.addEventListener('input', updateChange));

    document.getElementById('clearChange').addEventListener('click', () => {
      [priceOld, priceNew, paidOld, paidNew, changeOld, changeNew].forEach(el => el.value = '');
      updateChange();
      priceOld.focus();
    });

    // “السعر مكتوب…”
    document.getElementById('changePriceIsNewBtn').addEventListener('click', () => {
      priceOld.value = '0';
      priceNew.focus();
      updateChange();
    });
    document.getElementById('changePriceIsOldBtn').addEventListener('click', () => {
      priceNew.value = '0';
      priceOld.focus();
      updateChange();
    });

    // Toggle display currency under black section
    showOldBtn.addEventListener('click', () => {
      displayUnit = 'old';
      setActive(showOldBtn, showNewBtn, true);
      updateChange();
    });
    showNewBtn.addEventListener('click', () => {
      displayUnit = 'new';
      setActive(showOldBtn, showNewBtn, false);
      updateChange();
    });

    // Copy summary
    document.getElementById('copyChange').addEventListener('click', () => {
      // always include BOTH currencies in the copied text (useful in shop)
      const pO = parseNumber(priceOld.value), pN = parseNumber(priceNew.value);
      const payO = parseNumber(paidOld.value), payN = parseNumber(paidNew.value);
      const chO = parseNumber(changeOld.value), chN = parseNumber(changeNew.value);

      const priceOldTotal = totalOldFromInputs(pO, pN);
      const paidOldTotal = totalOldFromInputs(payO, payN);
      const receivedOldTotal = totalOldFromInputs(chO, chN);
      const expectedOld = paidOldTotal - priceOldTotal;
      const diffOld = receivedOldTotal - expectedOld;

      const text =
        `تحقق الباقي:\n` +
        `- السعر: ${fmtArNew(toNew(priceOldTotal))} جديدة | ${fmtAr(Math.round(priceOldTotal))} قديمة\n` +
        `- المدفوع: ${fmtArNew(toNew(paidOldTotal))} جديدة | ${fmtAr(Math.round(paidOldTotal))} قديمة\n` +
        `- الباقي المتوقع: ${fmtArNew(toNew(expectedOld))} جديدة | ${fmtAr(Math.round(expectedOld))} قديمة\n` +
        `- الباقي المستلم: ${fmtArNew(toNew(receivedOldTotal))} جديدة | ${fmtAr(Math.round(receivedOldTotal))} قديمة\n` +
        `- الفرق: ${fmtArNew(toNew(diffOld))} جديدة | ${fmtAr(Math.round(diffOld))} قديمة\n` +
        `قاعدة التحويل: 1 جديدة = ${OLD_PER_NEW} قديمة`;
      copyText(text, document.getElementById('copyChangeStatus'));
    });

    // ====================== تهيئة ======================
    updateConvert();
    updateChange();
  </script>
</body>
</html>
